<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Stitch - Mis Eventos</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#bd2bee',
                    },
                    fontFamily: {
                        sans: ['Spline Sans', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Spline Sans', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        .bg-main-bg {
            background-color: #f8fafc;
        }

        .bg-sidebar-bg {
            background-color: #ffffff;
        }

        .bg-white {
            background-color: #ffffff;
        }

        .text-slate-800,
        .text-slate-700 {
            color: #1e293b;
        }

        .text-slate-500,
        .text-slate-400 {
            color: #64748b;
        }

        .border-slate-100,
        .border-slate-200 {
            border-color: #f1f5f9;
        }

        .bg-slate-100 {
            background-color: #f1f5f9;
        }

        .active-nav {
            background: #bd2bee;
            color: white !important;
        }

        .sidebar {
            width: 260px;
        }

        /* Modal Styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(8px);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 2.5rem;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal-backdrop.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }
    </style>
</head>

<body class="bg-main-bg flex min-h-screen">

    <!-- Sidebar -->
    <aside class="sidebar h-screen sticky top-0 bg-sidebar-bg border-r border-slate-100 flex flex-col p-6 z-50">
        <div class="flex items-center gap-2 mb-10 px-2">
            <div class="size-8 bg-primary rounded-lg flex items-center justify-center">
                <i data-lucide="camera" class="text-white size-4"></i>
            </div>
            <span class="font-bold text-xl text-slate-800 tracking-tighter">Stitch<span
                    class="text-primary">.app</span></span>
        </div>

        <nav class="flex-1 space-y-2">
            <a href="/guest.html"
                class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl font-medium transition-all">
                <i data-lucide="user" class="size-5"></i> Perfil
            </a>
            <a href="/events.html"
                class="active-nav flex items-center gap-3 px-4 py-3 rounded-xl font-semibold transition-all shadow-lg shadow-primary/20">
                <i data-lucide="calendar" class="size-5"></i> Eventos
            </a>
            <a href="#"
                class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl font-medium transition-all">
                <i data-lucide="sparkles" class="size-5"></i> Servicios
            </a>
            <a href="#"
                class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl font-medium transition-all">
                <i data-lucide="image" class="size-5"></i> Álbumes
            </a>
            <a href="#"
                class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl font-medium transition-all">
                <i data-lucide="settings" class="size-5"></i> Configuración
            </a>
        </nav>

        <div class="mt-auto space-y-2">
            <a href="#"
                class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl font-medium">
                <i data-lucide="book-open" class="size-5 text-purple-500"></i> Blog
            </a>
            <button
                class="w-full bg-green-500 text-white flex items-center justify-center gap-3 py-3 rounded-xl font-bold shadow-lg shadow-green-500/20">
                <i data-lucide="message-circle" class="size-5"></i> Contactar
            </button>
            <button onclick="logout()"
                class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl font-medium transition-all">
                <i data-lucide="log-out" class="size-5"></i> Cerrar sesión
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 min-w-0">
        <!-- Header / Breadcrumbs -->
        <header class="bg-white px-8 py-6 flex items-center justify-between border-b border-slate-100">
            <div class="flex items-center gap-3 text-slate-500 text-sm font-semibold">
                <button onclick="history.back()"
                    class="bg-primary size-7 rounded-full flex items-center justify-center text-white">
                    <i data-lucide="arrow-left" class="size-4"></i>
                </button>
                <div class="flex items-center gap-2">
                    <i data-lucide="calendar" class="size-4 text-slate-400"></i>
                    <span>Inicio / Dashboard</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button class="relative p-2 hover:bg-slate-100 rounded-xl transition-colors">
                    <i data-lucide="bell" class="size-5 text-slate-400"></i>
                    <span class="absolute top-2 right-2 size-2 bg-primary rounded-full border-2 border-white"></span>
                </button>
                <div class="h-8 w-px bg-slate-100 mx-2"></div>
                <div class="w-10 h-10 bg-slate-200 rounded-full overflow-hidden">
                    <img id="header-avatar" class="w-full h-full object-cover hidden" src="" alt="">
                </div>
            </div>
        </header>

        <!-- Events Dashboard Content -->
        <div class="p-8 space-y-8">
            <!-- Welcome Message -->
            <div class="text-center space-y-2 py-4">
                <h2 class="text-3xl font-bold text-primary italic">¡Bienvenid@ de vuelta, <span
                        id="user-display-name">...</span>!</h2>
                <p class="text-slate-500 font-medium">Gestiona y organiza todos tus eventos fotográficos desde un solo
                    lugar.</p>
            </div>

            <!-- Upcoming Events Section -->
            <section class="space-y-4">
                <div class="flex items-center gap-2">
                    <i data-lucide="calendar" class="text-primary size-6"></i>
                    <h3 class="text-2xl font-bold text-slate-800">Próximos eventos</h3>
                </div>
                <div id="upcoming-events-list" class="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm">
                    <p class="text-slate-400 font-medium text-center py-4">No se encontraron eventos próximos. <span
                            class="text-primary font-bold cursor-pointer" onclick="openModal()">¡Crea uno para
                            empezar!</span></p>
                </div>
            </section>

            <!-- My Events Section -->
            <section class="space-y-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-slate-800">Mis Eventos</h3>
                    <button onclick="openModal()"
                        class="bg-primary hover:bg-primary/90 text-white font-bold px-6 py-3 rounded-2xl flex items-center gap-2 shadow-lg shadow-primary/20 transition-all active:scale-95">
                        <i data-lucide="plus-circle" class="size-5"></i>
                        Crear evento
                    </button>
                </div>
                <div id="all-events-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div
                        class="bg-white p-12 rounded-3xl border border-slate-100 shadow-sm text-center md:col-span-full">
                        <p class="text-slate-400 font-medium italic">Todavía no tienes eventos</p>
                    </div>
                </div>
            </section>

            <!-- News Section -->
            <section class="space-y-4">
                <h3 class="text-2xl font-bold text-primary italic">Novedades</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Placeholder cards for news style -->
                    <div class="bg-slate-100 h-40 rounded-3xl animate-pulse"></div>
                    <div class="bg-slate-100 h-40 rounded-3xl animate-pulse"></div>
                </div>
            </section>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <nav
        class="md:hidden fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-100 p-4 flex justify-around items-center z-50">
        <a href="/guest.html" class="text-slate-400 flex flex-col items-center gap-1">
            <i data-lucide="user" class="size-6"></i>
            <span class="text-[10px] font-bold uppercase">Perfil</span>
        </a>
        <a href="/events.html" class="text-primary flex flex-col items-center gap-1">
            <i data-lucide="calendar" class="size-6"></i>
            <span class="text-[10px] font-bold uppercase">Eventos</span>
        </a>
        <a href="/kiosk.html" class="text-slate-400 flex flex-col items-center gap-1">
            <i data-lucide="monitor" class="size-6"></i>
            <span class="text-[10px] font-bold uppercase">Kiosco</span>
        </a>
    </nav>

    <!-- New Event Modal -->
    <div id="new-event-modal" class="modal-backdrop" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="bg-primary p-6 text-white flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-xl">
                        <i data-lucide="calendar-plus" class="size-6"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold">Nuevo Evento</h3>
                        <p class="text-white/70 text-xs font-medium">Completa los datos de tu evento</p>
                    </div>
                </div>
                <button onclick="closeModal()" class="hover:bg-white/20 p-2 rounded-full transition-colors">
                    <i data-lucide="x" class="size-6"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <form id="new-event-form" class="p-8 space-y-6">
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-slate-700 ml-1">Nombre del evento</label>
                    <input type="text" id="event-name" required placeholder="Ej: Boda de Ana y Luis"
                        class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-4 focus:ring-primary/10 focus:border-primary outline-none transition-all placeholder:text-slate-400 font-medium">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700 ml-1">Fecha del evento</label>
                        <input type="date" id="event-date" required
                            class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-4 focus:ring-primary/10 focus:border-primary outline-none transition-all font-medium text-slate-600">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700 ml-1">Hora del evento</label>
                        <input type="time" id="event-time" required
                            class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-4 focus:ring-primary/10 focus:border-primary outline-none transition-all font-medium text-slate-600">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-slate-700 ml-1">Categoría</label>
                    <div class="relative">
                        <select id="event-category" required
                            class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-4 focus:ring-primary/10 focus:border-primary outline-none transition-all font-medium text-slate-600 appearance-none">
                            <option value="" disabled selected>Seleccionar categoría</option>
                            <option value="wedding">Boda</option>
                            <option value="birthday">XV Años / Cumpleaños</option>
                            <option value="corporate">Eventos Corporativos</option>
                            <option value="session">Sesión Fotográfica</option>
                            <option value="other">Otro</option>
                        </select>
                        <i data-lucide="chevron-down"
                            class="absolute right-4 top-1/2 -translate-y-1/2 size-5 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>

                <div class="flex items-center gap-3 pt-4">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 py-4 text-slate-500 font-bold hover:bg-slate-50 rounded-2xl transition-colors">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 py-4 bg-primary text-white font-bold rounded-2xl shadow-lg shadow-primary/20 hover:bg-primary/90 transition-all active:scale-95">
                        Crear Evento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global Initialization - Restore immediately
        document.addEventListener('DOMContentLoaded', () => {
            try {
                if (window.lucide) lucide.createIcons();
            } catch (e) { console.error('Lucide error:', e); }
        });

        // Auth Logic - Robust Check
        const userId = localStorage.getItem('userId');
        const userName = localStorage.getItem('userName');
        const avatarUrl = localStorage.getItem('avatarUrl');

        const isInvalidSession = !userId || userId === 'null' || userId === 'undefined';

        if (isInvalidSession) {
            console.warn('DEBUG: Sesión inválida detectada en events.html, redirigiendo...');
            window.location.href = '/login.html';
            return;
        }

        // Initialize Header & Greeting
        const headerAvatar = document.getElementById('header-avatar');
        const userDisplayName = document.getElementById('user-display-name');

        async function fetchHeaderData() {
            try {
                const res = await fetch(`/api/user/${userId}`);
                if (res.ok) {
                    const data = await res.json();
                    if (userDisplayName) userDisplayName.textContent = data.name || 'Usuario';
                    if (headerAvatar && data.avatar_url) {
                        headerAvatar.src = data.avatar_url;
                        headerAvatar.classList.remove('hidden');
                    }
                }
            } catch (err) {
                console.error('Error fetching header data:', err);
            }
        }

        // Initial populate from localStorage
        if (headerAvatar && avatarUrl) {
            headerAvatar.src = avatarUrl;
            headerAvatar.classList.remove('hidden');
        }

        if (userDisplayName) {
            userDisplayName.textContent = userName || 'Usuario';
        }

        // Fetch fresh data
        fetchHeaderData();

        function logout() {
            localStorage.clear();
            window.location.href = '/login.html';
        }

        // Modal Logic
        const modal = document.getElementById('new-event-modal');
        window.openModal = function () {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.closeModal = function () {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
            document.getElementById('new-event-form').reset();
        };

        // Persistence Logic
        async function loadEvents() {
            try {
                const res = await fetch(`/api/events/${userId}`);
                const events = await res.json();

                const upcomingContainer = document.getElementById('upcoming-events-list');
                const allContainer = document.getElementById('all-events-list');

                if (events.length === 0) {
                    upcomingContainer.innerHTML = `<p class="text-slate-400 font-medium text-center py-4">No se encontraron eventos próximos. <span class="text-primary font-bold cursor-pointer" onclick="openModal()">¡Crea uno para empezar!</span></p>`;
                    allContainer.innerHTML = `<div class="bg-white p-12 rounded-3xl border border-slate-100 shadow-sm text-center md:col-span-full"><p class="text-slate-400 font-medium italic">Todavía no tienes eventos</p></div>`;
                    return;
                }

                // Render All Events
                allContainer.innerHTML = events.map(event => `
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50 hover:scale-[1.02] transition-all cursor-pointer">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="size-12 bg-primary/10 rounded-2xl flex items-center justify-center text-primary">
                                <i data-lucide="tag" class="size-6"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800">${event.name}</h4>
                                <span class="text-xs font-bold text-primary uppercase bg-primary/5 px-2 py-0.5 rounded-lg">${event.category}</span>
                            </div>
                        </div>
                        <div class="space-y-2 mt-4">
                            <div class="flex items-center gap-2 text-slate-500 text-sm">
                                <i data-lucide="calendar" class="size-4"></i>
                                <span>${new Date(event.date).toLocaleDateString()}</span>
                            </div>
                            <div class="flex items-center gap-2 text-slate-500 text-sm">
                                <i data-lucide="clock" class="size-4"></i>
                                <span>${event.time.substring(0, 5)} hs</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Render first event as "Upcoming" for now
                const nextEvent = events[0];
                upcomingContainer.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-6">
                            <div class="size-16 bg-primary rounded-2xl flex items-center justify-center text-white shadow-lg shadow-primary/20">
                                <i data-lucide="calendar" class="size-8"></i>
                            </div>
                            <div>
                                <h4 class="text-xl font-bold text-slate-800">${nextEvent.name}</h4>
                                <p class="text-slate-500 font-medium">${new Date(nextEvent.date).toLocaleDateString()} • ${nextEvent.time.substring(0, 5)} hs</p>
                            </div>
                        </div>
                        <button class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold px-6 py-3 rounded-xl transition-colors">
                            Ver detalles
                        </button>
                    </div>
                `;

                if (window.lucide) lucide.createIcons();
            } catch (err) {
                console.error('Error loading events:', err);
            }
        }

        const eventForm = document.getElementById('new-event-form');
        if (!eventForm) {
            console.error('CRITICAL: Elemento "new-event-form" no encontrado');
            alert('Error técnico: No se encontró el formulario de eventos');
        }

        document.getElementById('new-event-form').onsubmit = async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i data-lucide="loader-2" class="size-5 animate-spin"></i>';
            lucide.createIcons();

            const eventData = {
                userId,
                name: document.getElementById('event-name').value,
                date: document.getElementById('event-date').value,
                time: document.getElementById('event-time').value,
                category: document.getElementById('event-category').value
            };

            try {
                const res = await fetch('/api/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });

                if (res.ok) {
                    closeModal();
                    loadEvents();
                } else {
                    const error = await res.json();
                    alert(`Error: ${error.message || 'No se pudo crear el evento'}`);
                }
            } catch (err) {
                console.error('Error submittig event:', err);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = 'Crear Evento';
            }
        };

        // Set greeting name from localStorage (fast path) then refresh from API
        const storedName = localStorage.getItem('userName');
        const storedUserId = localStorage.getItem('userId');
        const displayNameEl = document.getElementById('user-display-name');

        if (storedName) {
            displayNameEl.textContent = storedName.split(' ')[0]; // First name only
        }

        if (storedUserId) {
            fetch(`/api/user/${storedUserId}`)
                .then(r => r.ok ? r.json() : null)
                .then(data => {
                    if (data && data.name) {
                        const firstName = data.name.split(' ')[0];
                        displayNameEl.textContent = firstName;
                        localStorage.setItem('userName', data.name);
                    }
                })
                .catch(() => { }); // silently ignore errors
        }

        // Initial Load
        loadEvents();
    </script>

</body>

</html>